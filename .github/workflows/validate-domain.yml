name: éªŒè¯åŸŸåç”³è¯·

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'domains/**/*'  # ç›‘æ§ domains ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å˜åŒ–

jobs:
  validate-domain:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      pull-requests: read
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: pip install requests dnspython
        
      - name: è·å–æ›´æ”¹çš„æ–‡ä»¶
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: 'domains/**/*'
          separator: ' '
      
      - name: é¢„æ£€æŸ¥æ–‡ä»¶æ ¼å¼
        if: steps.changed-files.outputs.all_changed_files != ''
        run: |
          echo "=== é¢„æ£€æŸ¥æ–‡ä»¶æ ¼å¼ ==="
          echo "æ›´æ”¹çš„æ–‡ä»¶: ${{ steps.changed-files.outputs.all_changed_files }}"
          echo ""
          
          HAS_INVALID_FILES=false
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "æ£€æŸ¥æ–‡ä»¶: $file"
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•ç»“æ„ä¸­
            if [[ ! "$file" =~ ^domains/[^/]+/[^/]+\.json$ ]]; then
              echo "âŒ é”™è¯¯: æ–‡ä»¶è·¯å¾„æ ¼å¼ä¸æ­£ç¡®"
              echo "   æœŸæœ›æ ¼å¼: domains/{åŸŸå}/{å­åŸŸå}.json"
              echo "   å®é™…è·¯å¾„: $file"
              HAS_INVALID_FILES=true
              continue
            fi
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [[ ! -f "$file" ]]; then
              echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨"
              HAS_INVALID_FILES=true
              continue
            fi
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
            if [[ ! -s "$file" ]]; then
              echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸ºç©º"
              HAS_INVALID_FILES=true
              continue
            fi
            
            # åŸºæœ¬ JSON æ ¼å¼æ£€æŸ¥
            if ! python -m json.tool "$file" > /dev/null 2>&1; then
              echo "âŒ é”™è¯¯: JSON æ ¼å¼æ— æ•ˆ"
              echo "   è¯·ä½¿ç”¨ https://jsonlint.com/ éªŒè¯ JSON æ ¼å¼"
              HAS_INVALID_FILES=true
              continue
            fi
            
            echo "âœ… åŸºæœ¬æ ¼å¼æ£€æŸ¥é€šè¿‡"
          done
          
          if [ "$HAS_INVALID_FILES" = true ]; then
            echo ""
            echo "âŒ é¢„æ£€æŸ¥å‘ç°æ–‡ä»¶æ ¼å¼é—®é¢˜ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤"
            echo ""
            echo "ğŸ’¡ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ³•:"
            echo "1. æ–‡ä»¶å¿…é¡»æ”¾åœ¨ domains/{åŸŸå}/ ç›®å½•ä¸‹"
            echo "2. æ–‡ä»¶åå¿…é¡»ä»¥ .json ç»“å°¾"
            echo "3. æ–‡ä»¶å†…å®¹å¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼"
            echo "4. å¯ä»¥å‚è€ƒ domains/ciao.su/example.json ä½œä¸ºæ¨¡æ¿"
            exit 1
          fi
      
      - name: éªŒè¯åŸŸåé…ç½®
        if: steps.changed-files.outputs.all_changed_files != ''
        run: |
          # è®¾ç½® Python è·¯å¾„ä»¥ä¾¿æ­£ç¡®å¯¼å…¥æ¨¡å—
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          
          echo "=== å¼€å§‹éªŒè¯åŸŸåé…ç½® ==="
          echo "æ›´æ”¹çš„æ–‡ä»¶: ${{ steps.changed-files.outputs.all_changed_files }}"
          echo "PRä½œè€…: ${{ github.event.pull_request.user.login }}"
          echo "æ£€æŸ¥ä¿ç•™å­åŸŸå: å¯ç”¨"
          echo "æ£€æŸ¥æ–‡ä»¶æ ¼å¼: å¯ç”¨"
          echo ""
          
          # è¿è¡ŒéªŒè¯è„šæœ¬å¹¶ç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ŒåŒ…å«æ‰€æœ‰æƒéªŒè¯å’Œä¿ç•™å­åŸŸåæ£€æŸ¥
          if python scripts/bot/pr_checker.py \
            --files ${{ steps.changed-files.outputs.all_changed_files }} \
            --pr-author "${{ github.event.pull_request.user.login }}" \
            --repo-owner "${{ github.repository_owner }}" \
            --repo-name "${{ github.event.repository.name }}" \
            --github-token "${{ secrets.GITHUB_TOKEN }}" \
            --debug; then
            echo ""
            echo "ğŸ‰ æ‰€æœ‰åŸŸåé…ç½®éªŒè¯é€šè¿‡ï¼"
          else
            echo ""
            echo "âŒ åŸŸåé…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚"
            echo ""
            echo "ğŸ’¡ ä¿®å¤å»ºè®®:"
            echo "1. ä»”ç»†é˜…è¯»é”™è¯¯ä¿¡æ¯ä¸­çš„å…·ä½“é—®é¢˜"
            echo "2. å‚è€ƒ domains/ciao.su/example.json æ¨¡æ¿"
            echo "3. ä½¿ç”¨ https://jsonlint.com/ éªŒè¯ JSON æ ¼å¼"
            echo "4. æŸ¥çœ‹ç”¨æˆ·æŒ‡å—: https://github.com/bestzwei/LibreDomains/blob/main/docs/user-guide.md"
            exit 1
          fi
      
      - name: æ— æ–‡ä»¶æ›´æ”¹
        if: steps.changed-files.outputs.all_changed_files == ''
        run: |
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ° domains ç›®å½•ä¸‹çš„æ–‡ä»¶æ›´æ”¹ã€‚"
